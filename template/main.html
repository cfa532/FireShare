<!DOCTYPE html>
<html id="LeitherHtml">
<head id="LeitherHeader">
<script type="text/javascript">
function f(){
    var p, urls=[], ips=[], curNode=[]
    function getParam(){              
        return p
    }
    window["getParam"] = getParam;
    function setParam(param) {
        p = param
        initParam()
    }
    window["setParam"] = setParam;
    function initParam(){    
        // get public IPv4, or v6 if no v4
        var p=window.getParam()
        for (i=0; i< p.ips.length; i++){
            var ip = p.ips[i].split(":")
            if (ip.length<3) {
                // IPv4 address, 1.172.121.64:4800
                var a = ip[0].split('.')
                if ( a[0]==10 || (a[0]==192 && a[1]==168) || (a[0]==172 && a[1>15 && a[1]<32])) {
                    // private IPv4 for sure
                    continue;
                } else {
                    // public IPv4
                    ips.push([i, 4])         // p.CurNode = i; IPv4
                    urls.push(getUrl(p, i))
                }
            } else {
                // public IPv6, [2001:b011:e608:33c7:497d:480:498:45b8]:4800"
                // private, fe80::3509:974:e443:8b8c
                var a = p.ips[i].replace(/\[|\]/g,'').split(':');
                if (a.length < 8) {
                    // private IPv6
                    continue;
                } else {
                    // public IPv6
                    ips.push([i, 6])    // node id and node type
                    urls.push(getUrl(p, i))
                }
            }
        }
    };
    function getUrl(param, index) {
        var url ="http://"+ param["ips"][index] +"/entry?"
        if (param["aid"] != ""){
            url += "aid="+ param["aid"] + "&"
        }
        if (param["mid"] != ""){
            url += "mid="+ param["mid"] + "&"
        }
        if (param["ver"] != ""){
            url += "ver="+ param["ver"] + "&"
        }
        return url + "rand=" + Math.random()   
    };
    function replaceHtml(resp) {
        resp.text().then(txt=>{
            var html = document.getElementById("LeitherHtml");          
            var reg = /<html\s*\S*>([\s|\S]*)<\/html>/ig;
            txt.replace(reg, function() {                 
                html.innerHTML = arguments[1]
            });             
            var regsrc = /<script[^>]*>([\s|\S]*?)<\/script>/igm;    
            while ((result = regsrc.exec(txt))!= null){
                var script = document.createElement("script");
                script.textContent = result[1]
                document.getElementsByTagName("head")[0].appendChild(script);
            }
        }).catch(r=>{
            console.error(r);
        })
    }
    function requestEntry() {
        // get the first host IP that works
        urls.forEach((url, index) => {
            fetch(url, { CurNodeUrl: url, mode: 'cors' }).then(resp => {
                if (!resp.ok) {
                    console.error('HTTP error status: ' + url);
                    return
                }
                if (curNode[1] == 4) {
                    // a usable IPv4 address has been found. Quit.
                    console.log("A IPv4 node exists", ips[index])
                } else if (ips[index][1] == 4) {
                    // this node is IPv4, update curNode and fetch url
                    console.log("A IPv4 node found", ips[index])
                    curNode = ips[index]
                    p.curNode = ips[index][0]
                    replaceHtml(resp);
                    return
                } else {
                    if (curNode[1] != 6) {
                        // this node is IPv6 and curNode is null
                        curNode = ips[index]
                        p.curNode = ips[index][0]
                        replaceHtml(resp);
                    }
                }
            }).catch(r=>{
                console.error(r)
            })
        })
    }
    window["requestEntry"] = requestEntry    
}
f()

window.setParam({
        CurNode:0,
        log: true,
        ver:"last",
        aid: "{{.AppID}}",
        remote:"{{.RemoteIP}}",
        mid:"{{.MID}}",
        ips: {{.IPS}}
})
window.requestEntry()
</script>
</head>
</html>
 